# The Vision L

â†“æ±‚ä¸ªç¿»è¯‘


Do Virtual Gods Hand Out Electronic Visions?

## ç‰ˆæœ¬ / Versions
### ç¨³å®šç‰ˆ / Stable Release
- [L0.2.0](https://github.com/mr258876/Project_Vision_L/releases/tag/L0.2.0)
### æµ‹è¯•ç‰ˆ / Beta Release
- None
### å¼€å‘ç‰ˆ / Indev Release
- None

## æ”¯æŒåº“ / Referenced Libraries
- ä»¥ä¸‹åº“éœ€è¦æ‰‹åŠ¨å®‰è£… / Following libraries require manual installation before compile
```
Adafruit BusIO  1.14.1
ArduinoJson     6.19.4
KXTJ3-1057      0.0.1
LovyanGFX       0.4.18
LVGL            8.3.3
OneButton       2.0.3
```
- ä»¥ä¸‹åº“é€šè¿‡MITåè®®éšé¡¹ç›®åˆ†å‘ / Following libraries are distributed with this project under MIT license
```
APDS-9930       https://github.com/Depau/APDS9930
LinkedList      https://github.com/ivanseidel/LinkedList
```
- éƒ¨åˆ†ä»£ç å‚è€ƒäº†ä»¥ä¸‹é¡¹ç›® / Some code refer to following projects
```
RGB565_video    https://github.com/moononournation/RGB565_video
esp32_audio     https://github.com/atomic14/esp32_audio
```

## ä¸­æ–‡

è¯¥é¡¹ç›®ä¸ºç¡¬ä»¶é¡¹ç›®[ç’ƒæœˆç¥ä¹‹çœ¼ Extended](https://oshwhub.com/mr_258876/li-yue-shen-zhi-yan-gua-jian-extended)çš„å¯¹åº”å›ºä»¶ã€‚

å›ºä»¶ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§ç¡¬ä»¶ï¼š
- [ç’ƒæœˆç¥ä¹‹çœ¼ Extended by mr258876](https://oshwhub.com/mr_258876/li-yue-shen-zhi-yan-gua-jian-extended)
- [ç¥ä¹‹çœ¼æŒ‚ä»¶V1.2_ESP32U by å°æ¸£æ¸£](https://oshwhub.com/Myzhazha/shen-zhi-yan-gua-jian-v1-2_esp32u) (å®éªŒæ€§)
- [ç’ƒæœˆç¥ä¹‹çœ¼æŒ‚ä»¶ by å°æ¸£æ¸£](https://oshwhub.com/Myzhazha/li-yue-shen-zhi-yan-gua-jian) (å®éªŒæ€§ï¼Œæœªæµ‹è¯•)

## å¼€å‘è¿›åº¦

- æ˜¾ç¤ºå›¾ç‰‡/è§†é¢‘âœ…
- è®¾ç½®èœå•âœ…
- å¤šè¯­è¨€æ”¯æŒâœ…
- ä»ç±³æ¸¸ç¤¾APIè·å–æ ‘è„‚âœ…

ä¸‹ä¸ªå¤§ç‰ˆæœ¬ä¸­è®¡åˆ’çš„åŠŸèƒ½ï¼š
- è‡ªåŠ¨æ›´æ–°ğŸš§
- è“ç‰™ğŸš§
- æ¢å¤æ¨¡å¼(åº”å¯¹ROMä¸è¶³)ğŸš§
- ç»¼åˆä¿¡æ¯ç•Œé¢(æ•°å­—æ—¶é’Ÿ/å¤©æ°”/æ ‘è„‚æ•°æ®)ğŸš§
- ç®¡ç†ç•Œé¢(è¿œç¨‹æ§åˆ¶/æ–‡ä»¶ç®¡ç†)ğŸš§

## ä½¿ç”¨æ–¹æ³•
### L0.1ç‰ˆæœ¬
- çŸ­æŒ‰ä¸¤æ¬¡è·ç¦»ä¼ æ„Ÿå™¨åˆ‡æ¢å…ƒç´ (åˆ‡æ¢è§†é¢‘)

### L0.2ç‰ˆæœ¬åŠä»¥ä¸Š
- å•å‡»æŒ‰é’®å°†å…‰æ ‡ç§»è‡³ä¸‹ä¸€é¡¹
- åŒå‡»æŒ‰é’®ä¸æŒ‰é’®è¿›è¡Œäº¤äº’ï¼Œæˆ–ä¸æ— æŒ‰é’®å±å¹•è¿›è¡Œäº¤äº’(å›åˆ°èœå•)
- ä¸‰å‡»æŒ‰é’®å°†å…‰æ ‡ç§»è‡³ä¸Šä¸€é¡¹ï¼Œæˆ–ä¸æ— æŒ‰é’®å±å¹•è¿›è¡Œç¬¬äºŒäº¤äº’(åˆ‡æ¢å…ƒç´ /æ‰‹åŠ¨æ›´æ–°æ ‘è„‚æ•°æ®)

### ç±³æ¸¸ç¤¾/HoyoLab cookieè®¾ç½®
- æ‰“å¼€SDå¡æ ¹ç›®å½•`Hoyolab.json`ï¼Œå¹¶è®¾å®šç©å®¶idåŠç±³æ¸¸ç¤¾/Hoyolab cookieã€‚æ–‡ä»¶æ ¼å¼å‚è€ƒå¦‚ä¸‹ï¼š
```
{
    "uid": "100000000",
    "cookie": "PLACE YOUR COOKIE HERE è¯·åœ¨æ­¤å¤„å¡«å†™cookieå€¼",
    "device_guid": ""
}
```
- `device_guid` æ˜¯é€‰å¡«é¡¹ã€‚å…¶å€¼åº”ä¸ºä¸å«çŸ­æ¨ªçº¿çš„guidï¼Œå…±32ä½å­—ç¬¦ã€‚è‹¥ç•™ç©ºï¼Œç¥ä¹‹çœ¼å°†ä¼šè‡ªåŠ¨ç”Ÿæˆè¯¥å€¼ã€‚
- å¯¹äºç±³æ¸¸ç¤¾ï¼Œè¯·æ‰“å¼€ç±³æ¸¸ç¤¾å¹¶ç™»å½•ï¼Œéšåå°†ä»¥ä¸‹ä»£ç ç²˜è´´è‡³æµè§ˆå™¨æ§åˆ¶å°ä¸­è·å–cookieï¼š
```
let cookie_keys = ['_MHYUUID', 'ltoken', 'ltuid', 'cookie_token', 'account_id'];
var cookie = document.cookie;
var Str_Num = cookie.indexOf('_MHYUUID=');
var cookies = cookie.substring(Str_Num).split('; ');
for(var i = 0; i < cookies.length; i++){
    if(!cookie_keys.includes(cookies[i].split("=")[0])){
        cookies.splice(i--,1);
    }
}
cookie = '"cookie": "' + cookies.join('; ') + '"';
var ask = confirm('æŒ‰"ç¡®è®¤"å¤åˆ¶cookieè‡³å‰ªè´´æ¿');
if (ask == true) {
Â  copy(cookie);
Â  msg = cookie
} else {
Â  msg = 'Cancel'
}
```

### è‡ªå®šä¹‰å…ƒç´ é¡ºåº(è‡ªå®šä¹‰è§†é¢‘æ–‡ä»¶åŠé¡ºåº)
- æ‰“å¼€SDå¡æ ¹ç›®å½•`playFiles.json`ï¼Œå¹¶è®¾å®šè§†é¢‘/å›¾ç‰‡æ–‡ä»¶é¡ºåºåŠè·¯å¾„ã€‚è·¯å¾„éœ€è¦ä»¥ç›˜ç¬¦'S'å¼€å¤´ã€‚æ–‡ä»¶æ ¼å¼å‚è€ƒå¦‚ä¸‹ï¼š
```
{
    "files": [
        "S:/The_Vision_L/Pyro.mjpeg",
        "S:/æ°´.mjpeg",
        "S:/é£.jpg",
    ]
}
```
- æ³¨æ„ï¼šå›¾ç‰‡æ ¼å¼éœ€ä¸ºJPG/JPEGï¼Œå°ºå¯¸240\*240ä¸”å°äº12KBï¼Œè§†é¢‘æ ¼å¼éœ€ä¸ºMJPEGï¼Œå°ºå¯¸240\*240ä¸”æ¯å¸§å°äº12KBã€‚

## åˆ·å…¥å›ºä»¶
### åˆ·å…¥é¢„ç¼–è¯‘å›ºä»¶
0. å»ºç«‹ä¸²å£è¿æ¥ã€‚è‹¥ä½¿ç”¨çš„ä¸»æ¿ä¸ºå¼€å‘ç‰ˆï¼Œä½¿ç”¨Type-Cæ¥å£ç›´æ¥è¿æ¥ç”µè„‘å³å¯ï¼Œæ— éœ€é¢å¤–æ“ä½œï¼›è‹¥ä½¿ç”¨çš„ä¸»æ¿ä¸ºæ™®é€šç‰ˆï¼Œåˆ™éœ€ä½¿ç”¨é¢å¤–USB-ä¸²å£è½¬æ¢å™¨ï¼Œå¹¶æŒ‰ä¸‹å›¾å»ºç«‹æœ‰çº¿è¿æ¥(ä»¥CH341Aä¸‹è½½å™¨ä¸ºä¾‹)ã€‚
![image](/images/serial_conn.png)
1. ç§»æ­¥[ä¹é‘«ç§‘æŠ€ç½‘ç«™]("https://www.espressif.com.cn/zh-hans/support/download/other-tools")å¹¶ä¸‹è½½`ESP Download Tool(Flashä¸‹è½½å·¥å…·)`ã€‚

2. æ‰“å¼€ESP Download Toolï¼ŒèŠ¯ç‰‡ç±»å‹é€‰æ‹©`ESP32`ï¼Œå·¥ä½œæ¨¡å¼é€‰æ‹©`å¼€å‘æ¨¡å¼`ã€‚
![image](/images/flash_step1.png)
3. æŒ‰ç…§ä¸‹å›¾è®¾ç½®åˆ·å…¥çš„æ–‡ä»¶ã€flashåœ°å€ã€flashé€Ÿåº¦ï¼Œä¸²å£åŠä¸‹è½½é€Ÿåº¦æŒ‰å®é™…æƒ…å†µé€‰æ‹©ã€‚
![image](/images/flash_step2.png)
4. ç‚¹å‡»`ä¸‹è½½`æŒ‰é’®ã€‚è‹¥ä½¿ç”¨çš„ä¸»æ¿ä¸ºæ™®é€šç‰ˆï¼Œè¿˜éœ€åœ¨æŒ‰ä½BOOTé”®çš„åŒæ—¶çŸ­æŒ‰ENé”®ã€‚è‹¥ä¸‹è½½çŠ¶æ€ä¸€ç›´æ˜¾ç¤ºç­‰å¾…ä¸Šç”µåŒæ­¥ï¼Œé‡å¤æ­¤æ­¥éª¤ã€‚
![image](/images/boot_en_button.png)
5. å½“çŠ¶æ€æ˜¾ç¤º`å®Œæˆ`åï¼Œæ–­å¼€ä¸²å£è¿æ¥ã€‚

### å›ºä»¶å‡çº§
1. å°†firmware.biné‡å‘½åä¸ºupdate.binï¼Œå¹¶æ”¾ç½®äºSDå¡æ ¹ç›®å½•ä¸‹ã€‚
![image](images/update_rename.png)
2. å°†SDå¡æ’å…¥ç¥ä¹‹çœ¼ï¼Œç¥ä¹‹çœ¼ä¼šè‡ªåŠ¨å¼€å§‹å‡çº§è¿‡ç¨‹ã€‚
![image](images/self_updating.png)

### å·²çŸ¥é—®é¢˜
- ä½¿ç”¨å¾®ä¿¡AirKissåè®®è¿›è¡Œé…ç½‘æ—¶ï¼Œæ— æ³•ä½¿ç”¨å¯†ç ä¸ºç©ºçš„SSIDè¿›è¡Œé…ç½‘
- åœ¨SDå¡ä¸å±å¹•å…±äº«SPIæ€»çº¿çš„è®¾å¤‡ä¸Šï¼Œé€šè¿‡SDå¡æ›´æ–°å›ºä»¶æ—¶ç”»é¢æ˜¾ç¤ºè¢«å†»ç»“

### å¸¸è§é—®é¢˜è§£ç­”
#### ä¸ºä»€ä¹ˆè·å–ä½“åŠ›æ—¶ä¼šå‡ºç°â€œé”™è¯¯1034â€ï¼Ÿ
- å—ç±³æ¸¸ç¤¾é£æ§ç­–ç•¥å½±å“ï¼Œéƒ¨åˆ†æƒ…å†µç±³æ¸¸ç¤¾apiä¼šç›´æ¥è¿”å›é”™è¯¯1034ã€‚ç›®å‰çš„è§£å†³åŠæ³•ä¸ºåœ¨æ‰‹æœºä¸Šä½¿ç”¨ç±³æ¸¸ç¤¾appæŸ¥è¯¢ä½“åŠ›å¹¶ç­¾åˆ°ï¼Œéšåç¥ä¹‹çœ¼ä¸Šçš„æ ‘è„‚åŠŸèƒ½å°†æ¢å¤æ­£å¸¸ã€‚

## English

This is the firmware of hardware project [ç’ƒæœˆç¥ä¹‹çœ¼ Extended](https://oshwhub.com/mr_258876/li-yue-shen-zhi-yan-gua-jian-extended).

These following hardwares are also supported:
- [ç’ƒæœˆç¥ä¹‹çœ¼ Extended by mr258876](https://oshwhub.com/mr_258876/li-yue-shen-zhi-yan-gua-jian-extended)
- [ç¥ä¹‹çœ¼æŒ‚ä»¶V1.2_ESP32U by å°æ¸£æ¸£](https://oshwhub.com/Myzhazha/shen-zhi-yan-gua-jian-v1-2_esp32u) (Experimental)
- [ç’ƒæœˆç¥ä¹‹çœ¼æŒ‚ä»¶ by å°æ¸£æ¸£](https://oshwhub.com/Myzhazha/li-yue-shen-zhi-yan-gua-jian) (Experimental, Untested)

## Development Process

- Picture/Video display âœ…
- Setting menu âœ…
- Multi-language support âœ…
- Resin data syncing âœ…

Features planned for next major release:
- Automatic updateğŸš§
- Bluetooth ğŸš§
- Recovery mode (to solve ROM shortage) ğŸš§
- Integrated information interface (includes digital clock & weather & resin data) ğŸš§
- Management interface (remote control & file management) ğŸš§

## How to Use
### For version L0.1
- Short press twice on the distance sensor to switch elements (switch video)

### For version L0.2 or above
- Click power button to move cursor to next item
- Double-click power button to interact with a button item, or to interact with a buttonless screen (go back to menu)
- Triple-click power button to move cursor to previous item, or perform second interaction with a buttonless screen (switch element / manually update resin data)

### HoyoLab cookie settings
- Open `Hoyolab.json` in the root directory of SD card, then set character id and Hoyolab cookie. Example shown as below:
```
{
    "uid": "100000000",
    "cookie": "PLACE YOUR COOKIE HERE è¯·åœ¨æ­¤å¤„å¡«å†™cookieå€¼",
    "device_guid": ""
}
```
- `device_guid` is optional. It should be a random generated guid without dash line, 32 characters in total. The vision will generate one if left blank.

### Customizing element order (custom video file and order)
- Open `playFiles.json`in the root directory of SD card, then set the path and sequence of videos and pictures. The paths need include driver letter 'S'. Example shown as below:
```
{
    "files": [
        "S:/The_Vision_L/Pyro.mjpeg",
        "S:/æ°´.mjpeg",
        "S:/é£.jpg",
    ]
}
```
- Note: The format of pictures should be JPG/JPEG, with size 240px\*240px, file size less than 12KB; videos should be MJPEG, size 240px\*240px, less than 12 KB for each frame.

## Flashing Firmware
### Flashing recompiled firmware
0. Setup serial connection with the vision. If using a development version board, just connect the vision with a Type-C wire, no further operations required; otherwise you need a USB-TTL dongle, and setup the connection as shown (e.g. connect using a CH341A downloader).
![image](/images/serial_conn.png)
1. Move to [Espressif Systems](https://www.espressif.com.cn/en/support/download/other-tools) and download `ESP Download Tool (Flash Download Tool)`ã€‚

2. Open ESP Download Toolï¼Œselect `ESP32` for chip type, `development` for work mode.
![image](/images/flash_step1.png)
3. Set the files, flash address, flash speed according to the figure below. Set serial port and download speed according to the actual situation.
![image](/images/flash_step2.png)
4. Click `Download`. If not using a development version board, short press the EN key while holding the BOOT key. If the status always shows `sync`, repeat this step.
![image](/images/boot_en_button.png)
5. Disconnect when the status shows `Finish`.

### Updating Firmware
1. Rename `firmware.bin` to `update.bin` and place it in the SD card root directory.
![image](images/update_rename.png)
2. Insert SD card back in, the vision will start update automatically.
![image](images/self_updating.png)

### Known Issues
- Failure on wifi configuration through Wechat AirKiss protocol using SSID without password
- Screen will get frozen when updating firmware through SD card on devices with SD card and LCD screen sharing same SPI bus

### FAQ
#### Why do I get "Error 1034" when getting resin data?
- Affected by the risk control policy of Hoyoverse, the API directly returns error code 1034 in some cases. Current solution is to use Hoyolab app on your phone and check your resin, then the resin function on the vision should behave normally.